/* eslint-env mocha */
'use strict'

var assert = require('assert')

exports.port = 23433

exports.keys = {
  key: '-----BEGIN RSA PRIVATE KEY-----\n' +
       'DELETED_BASE64_STRING\n' +
       'DELETED_BASE64_STRING\n' +
       'DELETED_BASE64_STRING\n' +
       'DELETED_BASE64_STRING\n' +
       'DELETED_BASE64_STRING\n' +
       'DELETED_BASE64_STRING\n' +
       'DELETED_BASE64_STRING\n' +
       'DELETED_BASE64_STRING\n' +
       'DELETED_BASE64_STRING\n' +
       'DELETED_BASE64_STRING\n' +
       'DELETED_BASE64_STRING\n' +
       'DELETED_BASE64_STRING\n' +
       'DELETED_BASE64_STRING\n' +
       'DELETED_BASE64_STRING\n' +
       'DELETED_BASE64_STRING\n' +
       'DELETED_BASE64_STRING\n' +
       'DELETED_BASE64_STRING\n' +
       'DELETED_BASE64_STRING\n' +
       'DELETED_BASE64_STRING\n' +
       'DELETED_BASE64_STRING\n' +
       'DELETED_BASE64_STRING\n' +
       'DELETED_BASE64_STRING\n' +
       'DELETED_BASE64_STRING\n' +
       'DELETED_BASE64_STRING\n' +
       'DELETED_BASE64_STRING\n' +
       '-----END RSA PRIVATE KEY-----',
  cert: '-----BEGIN CERTIFICATE-----\n' +
        'DELETED_BASE64_STRING\n' +
        'DELETED_BASE64_STRING\n' +
        'DELETED_BASE64_STRING\n' +
        'DELETED_BASE64_STRING\n' +
        'DELETED_BASE64_STRING\n' +
        'DELETED_BASE64_STRING\n' +
        'DELETED_BASE64_STRING\n' +
        'DELETED_BASE64_STRING\n' +
        'DELETED_BASE64_STRING\n' +
        'DELETED_BASE64_STRING\n' +
        'DELETED_BASE64_STRING\n' +
        'DELETED_BASE64_STRING\n' +
        'DELETED_BASE64_STRING\n' +
        'DELETED_BASE64_STRING\n' +
        'DELETED_BASE64_STRING\n' +
        '-----END CERTIFICATE-----'
}

function expectData (stream, expected, callback) {
  var actual = ''

  stream.on('data', function (chunk) {
    actual += chunk
  })
  stream.on('end', function () {
    assert.strictEqual(actual, expected)
    callback()
  })
}
exports.expectData = expectData

exports.everyProtocol = function everyProtocol (body) {
  var protocols = [
    { protocol: 'http2', alpn: 'h2', version: 4 },
    { protocol: 'spdy', alpn: 'spdy/3.1', version: 3.1 },
    { protocol: 'spdy', alpn: 'spdy/3', version: 3 },
    { protocol: 'spdy', alpn: 'spdy/2', version: 2 }
  ]

  protocols.forEach(function (protocol) {
    describe(protocol.alpn, function () {
      body(protocol.protocol, protocol.alpn, protocol.version)
    })
  })
}

exports.everyConfig = function everyConfig (body) {
  exports.everyProtocol(function (protocol, alpn, version) {
    if (alpn === 'spdy/2') {
      return
    }

    [false, true].forEach(function (plain) {
      describe(plain ? 'plain mode' : 'ssl mode', function () {
        body(protocol, alpn, version, plain)
      })
    })
  })
}
