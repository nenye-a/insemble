/* Copyright 2013 Google Inc. All Rights Reserved.

   Distributed under MIT license.
   See file LICENSE for detail or copy at https://opensource.org/licenses/MIT
*/

/* Utilities for fast computation of logarithms. */

#ifndef BROTLI_ENC_FAST_LOG_H_
#define BROTLI_ENC_FAST_LOG_H_

#include <math.h>

#include "../common/platform.h"
#include <brotli/types.h>

#if defined(__cplusplus) || defined(c_plusplus)
extern "C" {
#endif

static BROTLI_INLINE uint32_t Log2FloorNonZero(size_t n) {
  /* TODO: generalize and move to platform.h */
#if BROTLI_GNUC_HAS_BUILTIN(__builtin_clz, 3, 4, 0) || \
    BROTLI_INTEL_VERSION_CHECK(16, 0, 0)
  return 31u ^ (uint32_t)__builtin_clz((uint32_t)n);
#else
  uint32_t result = 0;
  while (n >>= 1) result++;
  return result;
#endif
}

/* A lookup table for small values of log2(int) to be used in entropy
   computation.

   ", ".join(["%.16ff" % x for x in [0.0]+[log2(x) for x in range(1, 256)]]) */
static const float kLog2Table[] = {
  0.DELETED_CREDIT_CARDf, 0.DELETED_CREDIT_CARDf, 1.DELETED_CREDIT_CARDf,
  1.DELETED_CREDIT_CARDf, 2.DELETED_CREDIT_CARDf, 2.DELETED_CREDIT_CARDf,
  2.DELETED_CREDIT_CARDf, 2.DELETED_CREDIT_CARDf, 3.DELETED_CREDIT_CARDf,
  3.DELETED_CREDIT_CARDf, 3.DELETED_CREDIT_CARDf, 3.DELETED_CREDIT_CARDf,
  3.DELETED_CREDIT_CARDf, 3.DELETED_CREDIT_CARDf, 3.DELETED_CREDIT_CARDf,
  3.DELETED_CREDIT_CARDf, 4.DELETED_CREDIT_CARDf, 4.DELETED_CREDIT_CARDf,
  4.DELETED_CREDIT_CARDf, 4.DELETED_CREDIT_CARDf, 4.DELETED_CREDIT_CARDf,
  4.DELETED_CREDIT_CARDf, 4.DELETED_CREDIT_CARDf, 4.DELETED_CREDIT_CARDf,
  4.DELETED_CREDIT_CARDf, 4.DELETED_CREDIT_CARDf, 4.DELETED_CREDIT_CARDf,
  4.DELETED_CREDIT_CARDf, 4.DELETED_CREDIT_CARDf, 4.DELETED_CREDIT_CARDf,
  4.DELETED_CREDIT_CARDf, 4.DELETED_CREDIT_CARDf, 5.DELETED_CREDIT_CARDf,
  5.DELETED_CREDIT_CARDf, 5.DELETED_CREDIT_CARDf, 5.DELETED_CREDIT_CARDf,
  5.DELETED_CREDIT_CARDf, 5.DELETED_CREDIT_CARDf, 5.DELETED_CREDIT_CARDf,
  5.DELETED_CREDIT_CARDf, 5.DELETED_CREDIT_CARDf, 5.DELETED_CREDIT_CARDf,
  5.DELETED_CREDIT_CARDf, 5.DELETED_CREDIT_CARDf, 5.DELETED_CREDIT_CARDf,
  5.DELETED_CREDIT_CARDf, 5.DELETED_CREDIT_CARDf, 5.DELETED_CREDIT_CARDf,
  5.DELETED_CREDIT_CARDf, 5.DELETED_CREDIT_CARDf, 5.DELETED_CREDIT_CARDf,
  5.DELETED_CREDIT_CARDf, 5.DELETED_CREDIT_CARDf, 5.DELETED_CREDIT_CARDf,
  5.DELETED_CREDIT_CARDf, 5.DELETED_CREDIT_CARDf, 5.DELETED_CREDIT_CARDf,
  5.DELETED_CREDIT_CARDf, 5.DELETED_CREDIT_CARDf, 5.DELETED_CREDIT_CARDf,
  5.DELETED_CREDIT_CARDf, 5.DELETED_CREDIT_CARDf, 5.DELETED_CREDIT_CARDf,
  5.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf,
  6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf,
  6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf,
  6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf,
  6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf,
  6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf,
  6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf,
  6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf,
  6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf,
  6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf,
  6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf,
  6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf,
  6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf,
  6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf,
  6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf,
  6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf,
  6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf,
  6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf,
  6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf,
  6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf,
  6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf,
  6.DELETED_CREDIT_CARDf, 6.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf, 7.DELETED_CREDIT_CARDf,
  7.DELETED_CREDIT_CARDf
};

#define LOG_2_INV 1.DELETED_CREDIT_CARD

/* Faster logarithm for small integers, with the property of log2(0) == 0. */
static BROTLI_INLINE double FastLog2(size_t v) {
  if (v < sizeof(kLog2Table) / sizeof(kLog2Table[0])) {
    return kLog2Table[v];
  }
#if (defined(_MSC_VER) && _MSC_VER <= 1700) || \
    (defined(__ANDROID_API__) && __ANDROID_API__ < 18)
  /* Visual Studio 2012 and Android API levels < 18 do not have the log2()
   * function defined, so we use log() and a multiplication instead. */
  return log((double)v) * LOG_2_INV;
#else
  return log2((double)v);
#endif
}

#if defined(__cplusplus) || defined(c_plusplus)
}  /* extern "C" */
#endif

#endif  /* BROTLI_ENC_FAST_LOG_H_ */
